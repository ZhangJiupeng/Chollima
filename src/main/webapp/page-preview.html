<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Page Preview - Chollima</title>
  <!-- Bootstrap -->
  <link rel="stylesheet" type="text/css" href="./ext/bootstrap/3.3.7/css/bootstrap.min.css">
  <!-- Bootstrap Material Design -->
  <link rel="stylesheet" type="text/css" href="./ext/bootstrap-material-design/ext/font-roboto.css">
  <link rel="stylesheet" type="text/css" href="./ext/bootstrap-material-design/ext/font-material-icons.css">
  <link rel="stylesheet" type="text/css" href="./ext/bootstrap-material-design/0.5.10/dist/css/bootstrap-material-design.min.css">
  <link rel="stylesheet" type="text/css" href="./ext/bootstrap-material-design/0.5.10/dist/css/ripples.min.css">
  <!-- Toastr -->
  <link rel="stylesheet" type="text/css" href="./ext/toastr/build/toastr.min.css">
  <!-- Prism -->
  <link rel="stylesheet" type="text/css" href="./ext/prism/prism.css">
  <!-- Chollima -->
  <link rel="stylesheet" type="text/css" href="./stylesheets/frame.css">
  <link rel="stylesheet" type="text/css" href="./stylesheets/page-preview.css">
</head>

<body>
  <div class="container-fluid">
    <div class="row">
      <div id="sidebar" class="col-xs-12 hidden-xs col-sm-1 col-md-2">
        <span id="brand">
            <h1 class="text-capitalize text-center hidden-xs hidden-sm">chollima</h1>
            <img src="./img/gospy-logo-flat.svg" alt="logo" class="visible-xs visible-sm">
        </span>
        <ul class="nav nav-pills nav-stacked">
          <li data-container="body" data-trigger="hover" data-toggle="popover" data-placement="right" data-content="Dashboard">
            <a href="./dashboard.html" class="btn">
              <i class="material-icons">&#xE6DF;</i>
              <font class="hidden-sm">dashboard</font>
              <span class="badge hidden-xs hidden-sm">0</span>
            </a>
          </li>
          <li class="active" data-container="body" data-trigger="hover" data-toggle="popover" data-placement="right" data-content="Workshop">
            <a href="javascript:void(0)" class="btn">
              <i class="material-icons">&#xE30D;</i>
              <font class="hidden-sm">workshop</font>
            </a>
          </li>
          <li data-container="body" data-trigger="hover" data-toggle="popover" data-placement="right" data-content="Task Center">
            <a href="./task-center.html" class="btn">
              <i class="material-icons">&#xE163;</i>
              <font class="hidden-sm">task center</font>
            </a>
          </li>
          <!-- <li data-container="body" data-trigger="hover" data-toggle="popover" data-placement="right" data-content="Repository">
            <a href="javascript:void(0)" class="btn">
              <i class="material-icons">&#xE1DB;</i>
              <font class="hidden-sm">repository</font>
            </a>
          </li>
          <li data-container="body" data-trigger="hover" data-toggle="popover" data-placement="right" data-content="Extensions">
            <a href="javascript:void(0)" class="btn">
              <i class="material-icons">&#xE87B;</i>
              <font class="hidden-sm">extensions</font>
              <span class="badge hidden-xs hidden-sm">0</span>
            </a>
          </li>
          <li data-container="body" data-trigger="hover" data-toggle="popover" data-placement="right" data-content="Settings">
            <a href="javascript:void(0)" class="btn">
              <i class="material-icons">&#xE8B8;</i>
              <font class="hidden-sm">settings</font>
            </a>
          </li> -->
          <li data-container="body" data-trigger="hover" data-toggle="popover" data-placement="right" data-content="Logout">
            <a href="./logout.html" class="btn">
              <i class="material-icons">&#xE879;</i>
              <font class="hidden-sm">logout</font>
            </a>
          </li>
      </div>
      <div id="viewport" class="col-sm-11 col-sm-offset-1 col-md-10 col-md-offset-2">
        <div class="row">
          <header class="col-md-12">
            <ol class="breadcrumb">
              <li><a href="#">Home</a></li>
              <li><a href="./workshop.html">Workshop</a></li>
              <li class="active">PPDesigner</li>
            </ol>
          </header>
          <div id="cpanel" class="col-md-12">
            <div class="input-group">
              <div class="form-group label-floating is-empty">
                <input id="text-url" type="text" class="form-control" placeholder="Target URL">
              </div>
              <div class="input-group-btn">
                <button id="btn-forward" class="btn btn-sm" title="Forward"><i class="material-icons">&#xE154;</i></button>
              </div>
              <div class="input-group-btn">
                <button class="btn btn-sm" title="Save" data-toggle="modal" data-target="#confirm-dialog"><i class="material-icons">&#xE161;</i></button>
              </div>
            </div>
            <ul class="nav nav-tabs nav-tab-xs">
              <li id="tab-page" role="presentation" class="active"><a href="#page" aria-controls="page" role="tab" data-toggle="tab">Page View</a></li>
              <li id="tab-raw" role="presentation"><a href="#raw" aria-controls="raw" role="tab" data-toggle="tab">Raw</a></li>
              <li id="tab-data" role="presentation"><a href="#data" aria-controls="data" role="tab" data-toggle="tab">Data &amp; Links</a></li>
            </ul>
            <div class="tab-content">
              <iframe id="page" name="page" frameborder="0" role="tabpanel" class="tab-pane active">
                <i class="material-icons">&#xE002;</i> Oops! Your browser does not support iframe.
              </iframe>
              <pre id="raw" role="tabpanel" class="tab-pane"></pre>
              <div id="data" role="tabpanel" class="tab-pane">
                <div class="col-md-6">
                  <div class="table-responsive">
                    <table id="table-data" class="table table-striped"></table>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="table-responsive">
                    <table id="table-links" class="table table-striped"></table>
                  </div>
                </div>
              </div>
              <div id="toolbar" class="btn-toolbar" role="toolbar">
                <div class="btn-group-vertical btn-group-xs" role="group">
                  <button id="btn-texts" class="btn active" title="Data"><i class="material-icons">&#xE264;</i></button>
                  <button id="btn-links" class="btn" title="Links"><i class="material-icons">&#xE250;</i></button>
                  <button id="btn-erase" class="btn" title="Erase Selection"><i class="material-icons">&#xE16C;</i></button>
                  <button id="btn-xpath" class="btn" title="XPath Extractor"><i class="material-icons">&#xE86F;</i></button>
                  <button id="btn-siblings" class="btn" title="Bind with Siblings"><i class="material-icons">&#xE53B;</i></button>
                </div>
                <input id="xpath" type="text" class="form-control" placeholder="XPath">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="confirm-dialog" class="modal fade" tabindex="-1" style="display: none;">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
          <h4 class="modal-title">Save Page Processor</h4>
        </div>
        <div class="modal-body">
            <div class="form-group label-floating is-empty">
              <label class="control-label">Name</label>
              <input id="text-name" type="text" class="form-control">
            </div>
        </div>
        <!-- <div class="modal-body">Are you sure to save? &nbsp; (it CANNOT be modified again)</div> -->
        <div class="modal-footer">
          <button id="btn-save" type="button" class="btn btn-success" data-dismiss="modal">save<div class="ripple-container"></div></button>
          <button type="button" class="btn" data-dismiss="modal">cancel<div class="ripple-container"></div></button>
        </div>
      </div>
    </div>
  </div>
  <!-- Scripts -->
  <script src="./ext/jquery/dist/jquery.min.js" charset="utf-8"></script>
  <script src="./ext/bootstrap/3.3.7/js/bootstrap.min.js" charset="utf-8"></script>
  <script src="./ext/bootstrap-material-design/0.5.10/dist/js/material.min.js" charset="utf-8"></script>
  <script src="./ext/bootstrap-material-design/0.5.10/dist/js/ripples.js" charset="utf-8"></script>
  <script src="./ext/toastr/build/toastr.min.js" charset="utf-8"></script>
  <script src="./ext/prism/prism.js" charset="utf-8"></script>
  <script src="./ext/ellocate/jquery.ellocate.js" charset="utf-8"></script>
  <script src="./ext/jquery-xpath/0.3.1/jquery.xpath.min.js" charset="utf-8"></script>
  <script src="./js/constant.js" charset="utf-8"></script>
  <script>
    $.material.init();
    $.material.ripples();
    $.material.input();
    $.material.checkbox();
    $.material.radio();
    $(document).bind("contextmenu", function(e) {
      return false;
    });
    $('[data-toggle="popover"]').popover({
      delay: {
        "show": 500,
        "hide": 100
      }
    }).on("show.bs.popover", function() {
      return $("#sidebar > ul > li > a > font").is(":hidden");
    });

    toastr.options = {
      "progressBar": true
    };

    function resizeTabContent(element) {
      var height = $(document).height() - 150;
      element.css("height", height + "px");
    }

    var page;
    var links = false;
    var erase = false;
    var siblings = false;
    var preSelectElement;

    function updatePage(url) {
      if (url.trim() == "") {
        toastr["warning"]("Empty URL!");
        return false;
      }
      $("#page").attr("url", url);
      $("#text-url").css("cursor", "wait");
      $("#btn-forward").css("cursor", "wait");
      $("#raw").html("");
      $("#table-data").html("");
      $("#table-links").html("");
      $.ajax({
        url: API_PAGE_PREVIEW + "?url=" + url,
        type: "get",
        dataType: "json",
        success: function(result) {
          if (result.status == "success") {
            page = result.data;
            $("#page").attr("srcdoc", page);
            var iframe = document.getElementById("page");
            if ($("#raw").is(":visible")) {
              $("#tab-raw").click();
            }
            if (iframe.attachEvent) {
              iframe.attachEvent("onload", function() {
                loadElementPicker();
              });
            } else {
              iframe.onload = function() {
                loadElementPicker();
              };
            }
          } else if (result.status == "failure") {
            toastr["error"](result.data);
          }
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {
          toastr["error"]("Connection Lost!");
        },
        complete: function() {
          $("#text-url").css("cursor", "text");
          $("#btn-forward").css("cursor", "pointer");
        }
      });
    }

    function updateTabContent() {
      resizeTabContent($("#page"));
      resizeTabContent($("#raw"));
      resizeTabContent($("#data"));
    }

    function addPreStyle(doc) {
      doc.find('head').append(
        '\<style>\
      .c-link-pre-select {\
        outline: 2px solid #9e9e9e !important;\
        outline-offset: 1px !important;\
        background-color: #cdcece !important;\
        color: #000 !important;\
      }\
      .c-link-selected {\
        outline: 2px solid #03a9f4 !important;\
        outline-offset: 1px !important;\
        background-color: #b9ecff !important;\
        color: #000 !important;\
      }\
      .c-link-selected2 {\
        -webkit-box-shadow: 0 0 0 1px #fff, inset 0 0 0 2px #bd617f, inset 0 0 0 3px #fff !important;\
        box-shadow: 0 0 0 1px #fff, inset 0 0 0 2px #bd617f, inset 0 0 0 3px #fff !important;\
        background-color: #ffeda7 !important;\
        color: #000 !important;\
      }\
      .c-link-hover {\
        outline: 3px solid #ff9800 !important;\
        outline-offset: 2px !important;\
      }\
      .c-link-hover:hover {\
        outline: 3px solid #4caf50 !important;\
      }\
      </style>'
      );
    }

    function iframeDocument() {
      return document.getElementById('page').contentWindow.document;
    }

    function loadElementPicker() {
      var pagedoc = $("#page").contents();
      addPreStyle(pagedoc);
      $(pagedoc).find("body").bind('contextmenu', function() {
        return false;
      });
      var e = pagedoc.find(".c-link");
      e.unbind("mouseover mouseout mouseup")
        .bind("mouseover", function() {
          $(this).addClass("c-link-hover");
          if (siblings) {
            $(this).siblings(".c-link").addClass("c-link-hover");
          }
        }).bind("mouseout", function() {
          $(this).removeClass("c-link-hover");
          if (siblings) {
            $(this).siblings(".c-link").removeClass("c-link-hover");
          }
        }).bind("mouseup", function(e) {
          var className = links ? "c-link-selected2" : "c-link-selected";
          switch (e.which) {
            case 1:
              if (erase) {
                $(this).removeClass(className);
                if (siblings) {
                  $(this).siblings(".c-link").removeClass(className);
                }
              } else {
                $(this).addClass(className);
                if (siblings) {
                  $(this).siblings(".c-link").addClass(className);
                }
                if (preSelectElement != null) {
                  preSelectElement.removeClass("c-link-pre-select");
                  try {
                    var commonXPath = getCommonXPath(preSelectElement.ellocate().xpath, $(this).ellocate().xpath);
                    if (commonXPath == undefined) {
                      toastr["warning"]("No similar elements found.");
                    } else {
                      var similarElements = $(iframeDocument()).xpath(commonXPath);
                      similarElements.addClass(className);
                      toastr["success"](similarElements.size() + " similar elements marked!");
                    }
                  } catch (e) {
                    toastr["error"](e);
                  }
                  preSelectElement = null;
                }
              }
              break;
            case 3:
              if (!erase) {
                if ($(this).hasClass("c-link-pre-select")) {
                  break;
                }
                if (preSelectElement != null) {
                  preSelectElement.removeClass("c-link-pre-select");
                }
                $(this).addClass("c-link-pre-select");
                preSelectElement = $(this);
                toastr["info"]("You've got a pre-select element, left-click on one of its siblings to auto select all the similar elements.");
              }
              break;
          }
        });
      return false;
    }

    function getCommonXPath(xpath1, xpath2) {
      if (xpath1 == xpath2) {
        return xpath1;
      }
      var xpathArray1 = xpath1.split("/");
      var xpathArray2 = xpath2.split("/");
      if (xpathArray1.length != xpathArray2.length) {
        return;
      }
      var p1 = 0;
      while (xpathArray1[p1] == xpathArray2[p1]) {
        p1++;
      }
      var p2 = xpathArray1.length - 1;
      while (xpathArray1[p2] == xpathArray2[p2]) {
        p2--;
      }
      if (p1 == p2) {
        var target = xpathArray1[p1];
        if (target.indexOf("[") > 0 && target.indexOf("]") > 0) {
          xpathArray1[p1] = target.substring(0, target.indexOf("["));
          return xpathArray1.join("/");
        }
      }
    }

    function getDataXPaths() {
      var result = [];
      $("#page").contents().find(".c-link-selected").each(function() {
        result.push($(this).ellocate().xpath);
      });
      return result;
    }

    function getLinkXPaths() {
      var result = [];
      $("#page").contents().find(".c-link-selected2").each(function() {
        result.push($(this).ellocate().xpath);
      });
      return result;
    }

    function getProcessJson() {
      var jsonObj = {};
      jsonObj.url = $("#page").attr("url");
      jsonObj.data = getDataXPaths();
      jsonObj.links = getLinkXPaths();
      return jsonObj;
    }

    $(window).resize(function() {
      updateTabContent();
    });

    updateTabContent();

    $("#text-url").keydown(function(e) {
      if (e.keyCode == 13) {
        updatePage($(this).val().trim());
        $(this).blur();
      }
    });

    $("#xpath").keydown(function(e) {
      if (e.keyCode == 13) {
        try {
          var similarElements = $(iframeDocument()).xpath($(this).val());
          if (!erase) {
            similarElements.addClass(links ? "c-link-selected2" : "c-link-selected");
            toastr["success"](similarElements.size() + " xpath element(s) marked!");
          } else {
            similarElements.removeClass(links ? "c-link-selected2" : "c-link-selected");
            toastr["success"](similarElements.size() + " xpath element(s) erased!");
          }
        } catch (e) {
          toastr["error"](e);
        }
      }
    });

    $("#tab-page").click(function() {
      $("#toolbar").slideDown();
    });

    $("#tab-raw").click(function() {
      if (page != null) {
        $("#raw").html(Prism.highlight(page, Prism.languages.markup));
        page = null;
      }
      $("#toolbar").hide();
    });

    $("#tab-data").click(function() {
      var dataTable = "<tr><th>#</th><th>Data</th><th>XPath</th></tr>";
      var linkTable = "<tr><th>#</th><th>Links</th><th>XPath</th></tr>";
      var dataXPaths = getDataXPaths();
      var linkXPaths = getLinkXPaths();
      for (var i = 1; i <= dataXPaths.length; i++) {
        var xpath = dataXPaths[i - 1];
        var element = $(iframeDocument()).xpath(xpath);
        var item = element.text();
        dataTable += "<tr><td>" + i + "</td><td>" + item + "</td><td>" + xpath + "</td></tr>";
      }
      for (var i = 1; i <= linkXPaths.length; i++) {
        var xpath = linkXPaths[i - 1];
        var element = $(iframeDocument()).xpath(xpath);
        var item = element.attr("c-link-target");
        linkTable += "<tr><td>" + i + "</td><td>" + item + "</td><td>" + xpath + "</td></tr>";
      }
      $("#table-data").html(dataTable);
      $("#table-links").html(linkTable);
      $("#toolbar").hide();
    });

    $("#btn-forward").click(function() {
      updatePage($("#text-url").val().trim());
    });

    $("#btn-save").click(function() {
      var processJson = getProcessJson();
      if (processJson.url == undefined) {
        toastr["warning"]("You need to visit a page first!");
        $("#text-name").val("");
        return;
      }
      var name = $("#text-name").val();
      if (name.trim() == "") {
        toastr["warning"]("You must specify a name for this processor!");
        return false;
      }
      processJson.name = name;
      $("#text-name").val("");
      $.ajax({
        url: API_PROCESSOR_BASE + "cc.gospy.chollima.entity.component.impl.XPathProcessComponent/" + name,
        type: "post",
        dataType: "json",
        contentType: "application/json;charset=UTF-8",
        data: JSON.stringify(processJson),
        async: false,
        success: function(result) {
          if (result.status == "success") {
            location.href = "./workshop.html";
          } else {
            toastr["error"](result.data);
            return false;
          }
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {
          toastr["error"](XMLHttpRequest + " " + textStatus + " " + errorThrown);
          return false;
        }
      });
    });

    $("#btn-texts").click(function() {
      if (!$(this).hasClass("active")) {
        $(this).addClass("active");
        $("#btn-links").removeClass("active");
        links = false;
        if (erase) {
          toastr["info"]("Erase Data");
        } else {
          toastr["info"]("Select Data (for Saving)");
        }
      }
    });

    $("#btn-links").click(function() {
      if ($("#xpath").is(":visible")) {
        $("#xpath").val("").hide();
        $("#btn-xpath").removeClass("active");
        toastr["warning"]("Xpath selector is not available for <Links> mode!");
      }
      if (!$(this).hasClass("active")) {
        $(this).addClass("active");
        $("#btn-texts").removeClass("active");
        links = true;
        if (erase) {
          toastr["info"]("Erase Links");
        } else {
          toastr["info"]("Select Links (for New Task)");
        }
      }
    });

    $("#btn-erase").click(function() {
      if ($(this).hasClass("active")) {
        $(this).removeClass("active");
        erase = false;
        if (links) {
          toastr["info"]("Select Links (for New Task)");
        } else {
          toastr["info"]("Select Data (for Saving)");
        }
      } else {
        $(this).addClass("active");
        erase = true;
        toastr["info"]("Erase " + (links ? "Links" : "Data"));
      }
    });

    $("#btn-xpath").click(function() {
      if (links) {
        toastr["warning"]("Xpath selector is not available for <Links> mode!");
        return;
      }
      if ($(this).hasClass("active")) {
        $(this).removeClass("active");
        $("#xpath").val("").hide();
      } else {
        $(this).addClass("active");
        $("#xpath").show().focus();
      }
    });

    $("#btn-siblings").click(function() {
      if ($(this).hasClass("active")) {
        $(this).removeClass("active");
        siblings = false;
      } else {
        $(this).addClass("active");
        siblings = true;
      }
      loadElementPicker();
    });
  </script>
</body>

</html>
